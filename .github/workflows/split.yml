name: Split VLESS subscriptions

on:
  schedule:
    - cron: "0 4 * * *"
  workflow_dispatch:

jobs:
  split:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Download raw source
        run: |
          mkdir -p Protocols
          curl -L --fail \
          https://raw.githubusercontent.com/SoliSpirit/v2ray-configs/refs/heads/main/Protocols/vless.txt \
          -o Protocols/vless.txt

      - name: Split and filter configs
        run: |
          mkdir -p Output
          mkdir -p Output/gemini

          > Output/vless_general.txt
          > Output/vless_download.txt
          > Output/vless_stream.txt
          > Output/vless_gemini_candidates.txt

          while IFS= read -r line; do
            [ -z "$line" ] && continue

            # Gemini candidates (negative filtering)
            if echo "$line" | grep -Eiq 'reality|tls' \
               && ! echo "$line" | grep -Eiq 'ovh|hetzner|azure|google|amazon|digitalocean'; then
              echo "$line" >> Output/vless_gemini_candidates.txt
            fi

            # Download (UDP / hy2)
            if echo "$line" | grep -Eiq 'udp|hysteria|hy2'; then
              echo "$line" >> Output/vless_download.txt
            fi

            # Stream (stable TCP/TLS)
            if echo "$line" | grep -Eiq 'tls|tcp|ws'; then
              echo "$line" >> Output/vless_stream.txt
            fi

            # General
            echo "$line" >> Output/vless_general.txt

          done < Protocols/vless.txt

      - name: Split Gemini into 500-line chunks
        run: |
          split -l 500 Output/vless_gemini_candidates.txt Output/gemini/vless_gemini_
          i=1
          for f in Output/gemini/vless_gemini_*; do
            mv "$f" "Output/gemini/vless_gemini_${i}.txt"
            i=$((i+1))
          done
          rm Output/vless_gemini_candidates.txt

      - name: Commit outputs
        run: |
          git config user.name "github-actions"
          git config user.email "actions@github.com"
          git add Output/
          git commit -m "Auto update split subscriptions" || exit 0
          git push
